<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interface Formateur - Success Formation</title>
    <link rel="apple-touch-icon" href="img/Logo success Formation rec.PNG">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .form-group select, .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            appearance: auto;
            cursor: pointer;
            box-sizing: border-box;
        }
        .form-group input { cursor: text; margin-top: 8px; }
        .form-group select:focus, .form-group input:focus { border-color: #ce2a45; outline: none; }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ce2a45;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
        .apprenants-preview {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            margin-top: 8px;
            font-size: 13px;
            color: #555;
            max-height: 150px;
            overflow-y: auto;
        }
        .apprenant-item { padding: 4px 0; border-bottom: 1px solid #eee; }
        .apprenant-item:last-child { border-bottom: none; }
        .badge-count {
            display: inline-block;
            background: #ce2a45;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 6px;
        }
        optgroup { font-weight: bold; color: #333; }
        
        .info-jour {
            background: #eaf4ff;
            border-left: 4px solid #ce2a45;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
            color: #333;
        }
        /* === STYLES SUIVI PR√âSENCES === */
        .attendance-header { padding: 10px 0 14px; }
        .attendance-stats { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 8px; font-size: 14px; }
        .stat-present { color: #27ae60; font-weight: 600; }
        .stat-absent { color: #e74c3c; font-weight: 600; }
        .stat-total { color: #555; }
        
        .progress-bar-container { background: #f0f0f0; border-radius: 20px; height: 10px; overflow: hidden; margin-bottom: 4px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 20px; transition: width 0.6s ease; }
        .progress-label { font-size: 12px; color: #888; text-align: right; }
        .attendance-group { margin-top: 14px; }
        .group-title { font-weight: 700; font-size: 13px; padding: 6px 10px; border-radius: 6px; margin-bottom: 6px; }
        .present-title { background: #eafaf1; color: #27ae60; border-left: 4px solid #27ae60; }
        .absent-title { background: #fdf3f3; color: #e74c3c; border-left: 4px solid #e74c3c; }
        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 14px;
            transition: background 0.3s;
        }
        .attendance-item.present { background: #f0faf4; border-left: 3px solid #27ae60; }
        .attendance-item.absent { background: #fdf8f8; border-left: 3px solid #e0e0e0; color: #999; }
        .att-nom { font-weight: 500; }
        .att-heure { font-size: 12px; color: #27ae60; font-weight: 600; white-space: nowrap; }
        .att-statut { font-size: 12px; color: #bbb; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="img/Logo%20success%20Formation%20rec.PNG" alt="Success Formation">
                <span>Success Formation</span>
            </div>
            <h1>Interface d'√©margement</h1>
            <p class="subtitle">Espace Formateur</p>
        </header>

        <main>
            <div class="card">
                <h2><span class="icon">üìù</span> Informations Session</h2>
                
                <div id="info-jour" class="info-jour">üìÖ Chargement du jour...</div>

                <div class="form-group">
                    <label for="session-select">üè´ Session du jour *</label>
                    <select id="session-select" required>
                        <option value="">‚è≥ Chargement des sessions...</option>
                    </select>
                    <div id="manual-session-group" style="display:none;">
                        <input type="text" id="manual-formation" placeholder="Nom de la formation (ex: AMUM AFC)">
                    </div>
                </div>

                <div id="formateur-section" style="display:none;">
                    <div class="form-group">
                        <label for="formateur-select">üë®‚Äçüè´ Formateur *</label>
                        <select id="formateur-select" required>
                            <option value="">-- S√©lectionner votre nom --</option>
                        </select>
                        <div id="manual-formateur-group" style="display:none;">
                            <input type="text" id="manual-formateur-nom" placeholder="Votre Nom et Pr√©nom">
                        </div>
                    </div>
                </div>

                <!-- Hidden inputs pour stocker les infos extraites -->
                <input type="hidden" id="formateur-nom">
                <input type="hidden" id="formateur-prenom">
                <input type="hidden" id="formation">

                <div id="apprenants-section" style="display:none;">
                    <h3>üë• Apprenants attendus <span id="apprenants-count" class="badge-count">0</span></h3>
                    <div id="apprenants-list" class="apprenants-preview">
                        <em>S√©lectionnez une session pour voir les apprenants</em>
                    </div>
                </div>

                <div class="session-info-details">
                    <p><strong>üìÖ Date :</strong> <span id="current-date"></span></p>
                    <p><strong>üïí Cr√©neau :</strong> <span id="current-slot">Chargement...</span></p>
                </div>

                <button id="generate-qr" class="btn btn-primary" disabled>
                    <span class="icon">üîó</span> G√©n√©rer QR Code
                </button>
            </div>

            <div class="card hidden" id="qr-section">
                <h2><span class="icon">üì±</span> QR Code de Pointage</h2>
                <p>Faites scanner ce code aux apprenants pour qu'ils puissent √©marger.</p>
                
                <div id="qrcode-container" class="qrcode"></div>
                
                <div id="qr-validity" class="qr-validity"></div>

                <button id="download-qr" class="btn btn-secondary">
                    <span class="icon">üíæ</span> T√©l√©charger l'image
                </button>
            </div>

            <div class="card hidden" id="attendance-section">
                <h2><span class="icon">üë•</span> Suivi des pr√©sences <span id="refresh-badge" style="font-size:12px;color:#888;font-weight:normal;">üîÑ auto 10s</span></h2>
                <p class="info-text">Mis √† jour automatiquement toutes les 10 secondes.</p>
                <div id="attendance-list">
                    <div class="info-text">‚è≥ En attente de signatures...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Biblioth√®ques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="js/resources-loader.js"></script>
    <script src="js/formateur.js"></script>

    <script>
        const API_RESOURCES = 'https://suivi-presence-success.vercel.app/api';
        const JOURS = { 0:null, 1:'LUNDI', 2:'MARDI', 3:'MERCREDI', 4:'JEUDI', 5:'VENDREDI', 6:null };
        let apprenantsActuels = [];

        function getJourActuel() {
            return JOURS[new Date().getDay()] || null;
        }

        async function initSessions() {
            const jourActuel = getJourActuel();
            const infoJourEl = document.getElementById('info-jour');
            const selectSession = document.getElementById('session-select');

            infoJourEl.innerHTML = jourActuel 
                ? `üìÖ Aujourd'hui : <strong>${jourActuel}</strong> ‚Äî Sessions du jour + AFC disponibles`
                : `üö´ Week-end ‚Äî Seules les <strong>sessions AFC</strong> sont disponibles`;

            try {
                const res = await fetch(`${API_RESOURCES}/resources/all`);
                const ressources = await res.json();
                
                const sessionsMap = new Map();
                ressources.forEach(r => {
                    const key = `${r.jour}||${r.formation}`;
                    if (!sessionsMap.has(key)) sessionsMap.set(key, { jour: r.jour, formation: r.formation });
                });

                const sessionsAujourdHui = [];
                const sessionsAFC = [];

                sessionsMap.forEach(s => {
                    if (s.jour === 'AFC') sessionsAFC.push(s);
                    else if (jourActuel && s.jour === jourActuel) sessionsAujourdHui.push(s);
                });

                selectSession.innerHTML = '<option value="">-- S√©lectionner une session --</option>';
                
                if (sessionsAujourdHui.length > 0) {
                    const g1 = document.createElement('optgroup');
                    g1.label = `üìÖ Sessions ${jourActuel}`;
                    sessionsAujourdHui.sort((a,b) => a.formation.localeCompare(b.formation)).forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ jour: s.jour, formation: s.formation });
                        opt.textContent = `${s.jour} ‚Äî ${s.formation}`;
                        g1.appendChild(opt);
                    });
                    selectSession.appendChild(g1);
                }

                if (sessionsAFC.length > 0) {
                    const g2 = document.createElement('optgroup');
                    g2.label = 'üîÑ Sessions AFC (toujours disponibles)';
                    sessionsAFC.sort((a,b) => a.formation.localeCompare(b.formation)).forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ jour: s.jour, formation: s.formation });
                        opt.textContent = `AFC ‚Äî ${s.formation}`;
                        g2.appendChild(opt);
                    });
                    selectSession.appendChild(g2);
                }

                // Option Autre
                const optAutre = document.createElement('option');
                optAutre.value = "AUTRE";
                optAutre.textContent = "‚ûï Autre formation (saisie manuelle)...";
                selectSession.appendChild(optAutre);

                if (!sessionsAujourdHui.length && !sessionsAFC.length) {
                   // Si rien trouv√© mais on garde l'option Autre
                }

            } catch(e) {
                console.error('‚ùå Erreur sessions:', e);
                selectSession.innerHTML = '<option value="">Erreur de chargement</option>';
            }
        }

        document.getElementById('session-select').addEventListener('change', async function() {
            const val = this.value;
            const manualGroup = document.getElementById('manual-session-group');
            const formateurSection = document.getElementById('formateur-section');
            const apprenantsSection = document.getElementById('apprenants-section');
            const listEl = document.getElementById('apprenants-list');
            const countEl = document.getElementById('apprenants-count');
            const btnGenerate = document.getElementById('generate-qr');

            document.getElementById('formateur-nom').value = '';
            document.getElementById('formateur-prenom').value = '';
            document.getElementById('formation').value = '';
            formateurSection.style.display = 'none';
            apprenantsSection.style.display = 'none';
            btnGenerate.disabled = true;
            apprenantsActuels = [];
            
            if (typeof setListeApprenants === 'function') setListeApprenants([]);
            if (typeof setJourActuel === 'function') setJourActuel(null);

            if (!val) {
                manualGroup.style.display = 'none';
                return;
            }

            if (val === "AUTRE") {
                manualGroup.style.display = 'block';
                document.getElementById('manual-formation').value = '';
                
                // Configurer formateur pour Autre
                const selF = document.getElementById('formateur-select');
                selF.innerHTML = '<option value="">-- S√©lectionner votre nom --</option><option value="AUTRE">‚ûï Autre formateur (saisie manuelle)...</option>';
                formateurSection.style.display = 'block';
                return;
            }

            manualGroup.style.display = 'none';
            const { jour, formation } = JSON.parse(val);
            document.getElementById('formation').value = formation;
            if (typeof setJourActuel === 'function') setJourActuel(jour);

            // Charger formateurs
            try {
                const resF = await fetch(`${API_RESOURCES}/resources/formateurs?jour=${encodeURIComponent(jour)}&formation=${encodeURIComponent(formation)}`);
                const formateurs = await resF.json();
                const sel = document.getElementById('formateur-select');
                sel.innerHTML = '<option value="">-- S√©lectionner votre nom --</option>';
                formateurs.forEach(nom => {
                    const opt = document.createElement('option');
                    opt.value = nom;
                    opt.textContent = nom;
                    sel.appendChild(opt);
                });
                // Toujours ajouter Autre
                const optAutreF = document.createElement('option');
                optAutreF.value = "AUTRE";
                optAutreF.textContent = "‚ûï Mon nom n'est pas dans la liste...";
                sel.appendChild(optAutreF);

                formateurSection.style.display = 'block';
            } catch(e) { console.error('‚ùå Erreur formateurs:', e); }

            // Charger apprenants
            try {
                const resA = await fetch(`${API_RESOURCES}/resources/apprenants?jour=${encodeURIComponent(jour)}&formation=${encodeURIComponent(formation)}`);
                const apprenants = await resA.json();
                apprenantsActuels = apprenants;
                
                if (typeof setListeApprenants === 'function') setListeApprenants(apprenants);
                
                countEl.textContent = apprenants.length;
                listEl.innerHTML = apprenants.length > 0 
                    ? apprenants.map(nom => `<div class="apprenant-item">üë§ ${nom}</div>`).join('')
                    : '<em>Aucun apprenant trouv√©</em>';
                apprenantsSection.style.display = 'block';
            } catch(e) {
                listEl.innerHTML = '<em>‚ö†Ô∏è Impossible de charger les apprenants</em>';
            }
        });

        document.getElementById('formateur-select').addEventListener('change', function() {
            const val = this.value;
            const manualGroup = document.getElementById('manual-formateur-group');
            const btnGenerate = document.getElementById('generate-qr');

            if (!val) {
                manualGroup.style.display = 'none';
                btnGenerate.disabled = true;
                return;
            }

            if (val === "AUTRE") {
                manualGroup.style.display = 'block';
                document.getElementById('manual-formateur-nom').value = '';
                btnGenerate.disabled = false;
                return;
            }

            manualGroup.style.display = 'none';
            const parts = val.split(' ');
            document.getElementById('formateur-nom').value = parts[0] || '';
            document.getElementById('formateur-prenom').value = parts.slice(1).join(' ') || parts[0];
            btnGenerate.disabled = false;
        });

        window.addEventListener('DOMContentLoaded', initSessions);
    </script>
</body>
</html>
