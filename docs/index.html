<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interface Formateur - Success Formation</title>
    <link rel="apple-touch-icon" href="img/Logo success Formation rec.PNG">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Styles suppl√©mentaires pour les listes */
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            appearance: auto;
            cursor: pointer;
        }
        .form-group select:focus {
            border-color: #ce2a45;
            outline: none;
        }
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ce2a45;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .apprenants-preview {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            margin-top: 8px;
            font-size: 13px;
            color: #555;
            max-height: 120px;
            overflow-y: auto;
        }
        .apprenants-preview .apprenant-item {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }
        .apprenants-preview .apprenant-item:last-child {
            border-bottom: none;
        }
        .badge-count {
            display: inline-block;
            background: #ce2a45;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="img/Logo success Formation rec.PNG" alt="Success Formation" class="header-logo">
            <h1>Interface d'√©margement</h1>
            <p class="subtitle">Espace Formateur</p>
        </header>

        <div class="card">
            <h2><span class="icon">üìù</span> Informations Session</h2>

            <!-- S√©lection du Formateur -->
            <div class="form-group">
                <label for="formateur-select">üë®‚Äçüè´ Formateur *</label>
                <select id="formateur-select" required>
                    <option value="">‚è≥ Chargement des formateurs...</option>
                </select>
            </div>

            <!-- Champs cach√©s pour compatibilit√© avec formateur.js -->
            <input type="hidden" id="formateur-nom">
            <input type="hidden" id="formateur-prenom">

            <!-- S√©lection de la Formation -->
            <div class="form-group">
                <label for="formation">üè´ Formation *</label>
                <select id="formation" required>
                    <option value="">‚è≥ Chargement des formations...</option>
                </select>
            </div>

            <!-- Liste des apprenants attendus -->
            <div class="form-group" id="apprenants-section" style="display:none;">
                <label>üë• Apprenants attendus <span id="apprenants-count" class="badge-count">0</span></label>
                <div class="apprenants-preview" id="apprenants-list">
                    <em>S√©lectionnez une formation pour voir les apprenants</em>
                </div>
            </div>

            <div class="info-box">
                <p><strong>üìÖ Date :</strong> <span id="current-date"></span></p>
                <p><strong>üïí Cr√©neau :</strong> <span id="current-slot">Chargement...</span></p>
            </div>

            <button class="btn-primary" id="generate-qr">
                <span>üîó</span> G√©n√©rer QR Code
            </button>
        </div>

        <div class="card hidden" id="qr-section">
            <h2><span class="icon">üì±</span> QR Code de Pointage</h2>
            <p class="info-text">Faites scanner ce code aux apprenants pour qu'ils puissent √©marger.</p>
            
            <div id="qrcode-container"></div>

            <div class="qr-info" id="qr-validity"></div>

            <button class="btn-secondary" id="download-qr">
                <span>üíæ</span> T√©l√©charger l'image
            </button>
        </div>

        <div class="card hidden" id="attendance-section">
            <h2><span class="icon">üë•</span> Pr√©sences du jour</h2>
            <p class="info-text">Les signatures s'affichent en temps r√©el.</p>
            <div id="attendance-list">
                <div class="info-text">‚è≥ En attente de signatures...</div>
            </div>
        </div>
    </div>

    <!-- Biblioth√®ques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="js/resources-loader.js"></script>
    <script src="js/formateur.js"></script>

    <!-- Initialisation des listes d√©roulantes -->
    <script>
    const API_RESOURCES = 'https://suivi-presence-success.vercel.app/api';
    let apprenantsData = [];

    // 1. Charger les formations au d√©marrage
    async function initFormations() {
        try {
            const res = await fetch(`${API_RESOURCES}/resources/formations`);
            const formations = await res.json();

            const selectFormation = document.getElementById('formation');
            selectFormation.innerHTML = '<option value="">-- S√©lectionner --</option>';

            formations.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f;
                selectFormation.appendChild(opt);
            });
        } catch(e) {
            console.warn('‚ö†Ô∏è  Impossible de charger les formations depuis l\'API, utilisation liste de secours');
            const selectFormation = document.getElementById('formation');
            selectFormation.innerHTML = `
                <option value="">-- S√©lectionner --</option>
                <option value="TLE">TLE</option>
                <option value="TSMEL">TSMEL</option>
                <option value="MUM">MUM</option>
                <option value="AMUM">AMUM</option>
                <option value="ASCOM">ASCOM</option>
                <option value="CV">CV</option>
                <option value="GRAPHISTE">GRAPHISTE</option>
                <option value="NTC">NTC</option>
                <option value="REM">REM</option>
                <option value="FPA">FPA</option>
            `;
        }
    }

    // 2. Charger les formateurs au d√©marrage
    async function initFormateurs() {
        try {
            const res = await fetch(`${API_RESOURCES}/resources/formateurs`);
            const formateurs = await res.json();

            const selectFormateur = document.getElementById('formateur-select');
            selectFormateur.innerHTML = '<option value="">-- S√©lectionner votre nom --</option>';

            formateurs.forEach(nom => {
                const opt = document.createElement('option');
                opt.value = nom;
                opt.textContent = nom;
                selectFormateur.appendChild(opt);
            });

        } catch(e) {
            console.warn('‚ö†Ô∏è  Impossible de charger les formateurs');
            const selectFormateur = document.getElementById('formateur-select');
            selectFormateur.innerHTML = '<option value="">-- Saisir manuellement --</option>';
        }
    }

    // 3. Quand on choisit un formateur, remplir nom/pr√©nom cach√©s
    document.getElementById('formateur-select').addEventListener('change', function() {
        const nomComplet = this.value; // Ex: "GORECKI Sylvain"
        if (!nomComplet) {
            document.getElementById('formateur-nom').value = '';
            document.getElementById('formateur-prenom').value = '';
            return;
        }
        const parts = nomComplet.split(' ');
        // Conventionnellement: premier mot = NOM, reste = pr√©nom
        document.getElementById('formateur-nom').value = parts[0] || '';
        document.getElementById('formateur-prenom').value = parts.slice(1).join(' ') || parts[0];
    });

    // 4. Quand on choisit une formation, charger les apprenants
    document.getElementById('formation').addEventListener('change', async function() {
        const formation = this.value;
        const section = document.getElementById('apprenants-section');
        const listEl = document.getElementById('apprenants-list');
        const countEl = document.getElementById('apprenants-count');

        if (!formation) {
            section.style.display = 'none';
            return;
        }

        listEl.innerHTML = '<span class="loading-spinner"></span> Chargement des apprenants...';
        section.style.display = 'block';

        try {
            const res = await fetch(`${API_RESOURCES}/resources/apprenants?formation=${encodeURIComponent(formation)}`);
            apprenantsData = await res.json();

            countEl.textContent = apprenantsData.length;

            if (apprenantsData.length === 0) {
                listEl.innerHTML = '<em>Aucun apprenant trouv√© pour cette formation</em>';
                return;
            }

            listEl.innerHTML = apprenantsData
                .map(nom => `<div class="apprenant-item">üë§ ${nom}</div>`)
                .join('');

        } catch(e) {
            listEl.innerHTML = '<em>‚ö†Ô∏è  Impossible de charger les apprenants</em>';
            console.error(e);
        }
    });

    // 5. Initialisation au chargement de la page
    window.addEventListener('DOMContentLoaded', () => {
        initFormations();
        initFormateurs();
    });
    </script>
</body>
</html>
