<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interface Formateur - Success Formation</title>
    <link rel="apple-touch-icon" href="img/Logo success Formation rec.PNG">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            appearance: auto;
            cursor: pointer;
        }
        .form-group select:focus {
            border-color: #ce2a45;
            outline: none;
        }
        .form-group select option:disabled {
            color: #aaa;
            font-style: italic;
        }
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ce2a45;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .apprenants-preview {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            margin-top: 8px;
            font-size: 13px;
            color: #555;
            max-height: 150px;
            overflow-y: auto;
        }
        .apprenant-item {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        .apprenant-item:last-child { border-bottom: none; }
        .badge-count {
            display: inline-block;
            background: #ce2a45;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 6px;
        }
        .badge-afc {
            display: inline-block;
            background: #e67e22;
            color: white;
            border-radius: 10px;
            padding: 1px 7px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        optgroup {
            font-weight: bold;
            color: #333;
        }
        .info-jour {
            background: #eaf4ff;
            border-left: 4px solid #ce2a45;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="img/Logo success Formation rec.PNG" alt="Success Formation" class="header-logo">
            <h1>Interface d'√©margement</h1>
            <p class="subtitle">Espace Formateur</p>
        </header>

        <div class="card">
            <h2><span class="icon">üìù</span> Informations Session</h2>

            <!-- Info jour actuel -->
            <div class="info-jour" id="info-jour">
                üìÖ Chargement du jour...
            </div>

            <!-- S√©lection de la Session (Jour + Formation) -->
            <div class="form-group">
                <label for="session-select">üè´ Session du jour *</label>
                <select id="session-select" required>
                    <option value="">‚è≥ Chargement des sessions...</option>
                </select>
            </div>

            <!-- S√©lection du Formateur (filtr√© apr√®s choix session) -->
            <div class="form-group" id="formateur-section" style="display:none;">
                <label for="formateur-select">üë®‚Äçüè´ Formateur *</label>
                <select id="formateur-select" required>
                    <option value="">-- S√©lectionner votre nom --</option>
                </select>
            </div>

            <!-- Champs cach√©s pour compatibilit√© avec formateur.js -->
            <input type="hidden" id="formateur-nom">
            <input type="hidden" id="formateur-prenom">
            <input type="hidden" id="formation">

            <!-- Liste des apprenants attendus -->
            <div class="form-group" id="apprenants-section" style="display:none;">
                <label>üë• Apprenants attendus <span id="apprenants-count" class="badge-count">0</span></label>
                <div class="apprenants-preview" id="apprenants-list">
                    <em>S√©lectionnez une session pour voir les apprenants</em>
                </div>
            </div>

            <div class="info-box">
                <p><strong>üìÖ Date :</strong> <span id="current-date"></span></p>
                <p><strong>üïí Cr√©neau :</strong> <span id="current-slot">Chargement...</span></p>
            </div>

            <button class="btn-primary" id="generate-qr" disabled>
                <span>üîó</span> G√©n√©rer QR Code
            </button>
        </div>

        <div class="card hidden" id="qr-section">
            <h2><span class="icon">üì±</span> QR Code de Pointage</h2>
            <p class="info-text">Faites scanner ce code aux apprenants pour qu'ils puissent √©marger.</p>
            <div id="qrcode-container"></div>
            <div class="qr-info" id="qr-validity"></div>
            <button class="btn-secondary" id="download-qr">
                <span>üíæ</span> T√©l√©charger l'image
            </button>
        </div>

        <div class="card hidden" id="attendance-section">
            <h2><span class="icon">üë•</span> Pr√©sences du jour</h2>
            <p class="info-text">Les signatures s'affichent en temps r√©el.</p>
            <div id="attendance-list">
                <div class="info-text">‚è≥ En attente de signatures...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="js/resources-loader.js"></script>

    <script>
    const API_RESOURCES = 'https://suivi-presence-success.vercel.app/api';

    // Correspondance num√©ro de jour JS -> nom en fran√ßais
    const JOURS = {
        0: null,        // Dimanche - ferm√©
        1: 'LUNDI',
        2: 'MARDI',
        3: 'MERCREDI',
        4: 'JEUDI',
        5: 'VENDREDI',
        6: null         // Samedi - ferm√©
    };

    // Obtenir le jour actuel
    function getJourActuel() {
        const now = new Date();
        return JOURS[now.getDay()] || null;
    }

    // Charger toutes les ressources et construire la liste des sessions
    async function initSessions() {
        const jourActuel = getJourActuel();
        const infoJourEl = document.getElementById('info-jour');
        const selectSession = document.getElementById('session-select');

        // Afficher le jour actuel
        if (jourActuel) {
            infoJourEl.innerHTML = `üìÖ Aujourd'hui : <strong>${jourActuel}</strong> ‚Äî Seules les sessions du jour + AFC sont disponibles`;
        } else {
            infoJourEl.innerHTML = `üö´ Pas de cours aujourd'hui (week-end) ‚Äî Seules les <strong>sessions AFC</strong> sont disponibles`;
        }

        try {
            // R√©cup√©rer toutes les ressources
            const res = await fetch(`${API_RESOURCES}/resources/all`);
            const ressources = await res.json();

            // Construire les sessions uniques (Jour + Formation)
            const sessionsMap = new Map();
            ressources.forEach(r => {
                const key = `${r.jour}||${r.formation}`;
                if (!sessionsMap.has(key)) {
                    sessionsMap.set(key, { jour: r.jour, formation: r.formation });
                }
            });

            // S√©parer sessions du jour, AFC, et autres
            const sessionsAujourdHui = [];
            const sessionsAFC = [];

            sessionsMap.forEach(session => {
                if (session.jour === 'AFC') {
                    sessionsAFC.push(session);
                } else if (jourActuel && session.jour === jourActuel) {
                    sessionsAujourdHui.push(session);
                }
                // Les autres jours sont ignor√©s
            });

            // Construire le select avec groupes
            selectSession.innerHTML = '<option value="">-- S√©lectionner une session --</option>';

            // Groupe sessions du jour
            if (sessionsAujourdHui.length > 0) {
                const group1 = document.createElement('optgroup');
                group1.label = `üìÖ Sessions ${jourActuel || 'du jour'}`;
                sessionsAujourdHui
                    .sort((a, b) => a.formation.localeCompare(b.formation))
                    .forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ jour: s.jour, formation: s.formation });
                        opt.textContent = `${s.jour} ‚Äî ${s.formation}`;
                        group1.appendChild(opt);
                    });
                selectSession.appendChild(group1);
            }

            // Groupe AFC (toujours disponible)
            if (sessionsAFC.length > 0) {
                const group2 = document.createElement('optgroup');
                group2.label = 'üîÑ Sessions AFC (toujours disponibles)';
                sessionsAFC
                    .sort((a, b) => a.formation.localeCompare(b.formation))
                    .forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ jour: s.jour, formation: s.formation });
                        opt.textContent = `AFC ‚Äî ${s.formation} üîÑ`;
                        group2.appendChild(opt);
                    });
                selectSession.appendChild(group2);
            }

            if (sessionsAujourdHui.length === 0 && sessionsAFC.length === 0) {
                selectSession.innerHTML = '<option value="">Aucune session disponible</option>';
            }

        } catch(e) {
            console.error('‚ùå Erreur chargement sessions:', e);
            selectSession.innerHTML = '<option value="">Erreur de chargement</option>';
            infoJourEl.innerHTML = '‚ö†Ô∏è Impossible de contacter le serveur';
        }
    }

    // Quand on choisit une session -> charger formateurs + apprenants
    document.getElementById('session-select').addEventListener('change', async function() {
        const val = this.value;
        const formateurSection = document.getElementById('formateur-section');
        const apprenantsSection = document.getElementById('apprenants-section');
        const listEl = document.getElementById('apprenants-list');
        const countEl = document.getElementById('apprenants-count');
        const btnGenerate = document.getElementById('generate-qr');

        // Reset
        document.getElementById('formateur-nom').value = '';
        document.getElementById('formateur-prenom').value = '';
        document.getElementById('formation').value = '';
        formateurSection.style.display = 'none';
        apprenantsSection.style.display = 'none';
        btnGenerate.disabled = true;

        if (!val) return;

        const { jour, formation } = JSON.parse(val);

        // Mettre √† jour le champ cach√© formation pour formateur.js
        document.getElementById('formation').value = formation;

        // Charger formateurs filtr√©s
        try {
            const resF = await fetch(
                `${API_RESOURCES}/resources/formateurs?jour=${encodeURIComponent(jour)}&formation=${encodeURIComponent(formation)}`
            );
            const formateurs = await resF.json();

            const selectFormateur = document.getElementById('formateur-select');
            selectFormateur.innerHTML = '<option value="">-- S√©lectionner votre nom --</option>';

            formateurs.forEach(nom => {
                const opt = document.createElement('option');
                opt.value = nom;
                opt.textContent = nom;
                selectFormateur.appendChild(opt);
            });

            formateurSection.style.display = 'block';
        } catch(e) {
            console.error('‚ùå Erreur formateurs:', e);
        }

        // Charger apprenants filtr√©s
        try {
            const resA = await fetch(
                `${API_RESOURCES}/resources/apprenants?jour=${encodeURIComponent(jour)}&formation=${encodeURIComponent(formation)}`
            );
            const apprenants = await resA.json();

            countEl.textContent = apprenants.length;
            listEl.innerHTML = apprenants.length > 0
                ? apprenants.map(nom => `<div class="apprenant-item">üë§ ${nom}</div>`).join('')
                : '<em>Aucun apprenant trouv√©</em>';

            apprenantsSection.style.display = 'block';
        } catch(e) {
            listEl.innerHTML = '<em>‚ö†Ô∏è Impossible de charger les apprenants</em>';
        }
    });

    // Quand on choisit un formateur -> remplir nom/pr√©nom cach√©s + activer bouton
    document.getElementById('formateur-select').addEventListener('change', function() {
        const nomComplet = this.value;
        const btnGenerate = document.getElementById('generate-qr');

        if (!nomComplet) {
            document.getElementById('formateur-nom').value = '';
            document.getElementById('formateur-prenom').value = '';
            btnGenerate.disabled = true;
            return;
        }

        const parts = nomComplet.split(' ');
        document.getElementById('formateur-nom').value = parts[0] || '';
        document.getElementById('formateur-prenom').value = parts.slice(1).join(' ') || parts[0];
        btnGenerate.disabled = false;
    });

    // Initialisation
    window.addEventListener('DOMContentLoaded', initSessions);
    </script>

    <script src="js/formateur.js"></script>
</body>
</html>
